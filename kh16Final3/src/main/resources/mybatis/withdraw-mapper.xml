<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="withdraw">

  <!-- 환전 요청 생성 -->
  <insert id="insert" parameterType="PointWithdrawDto">
    <selectKey keyProperty="withdrawNo" resultType="long" order="BEFORE">
      select point_withdraw_seq.nextval from dual
    </selectKey>

    insert into point_withdraw (
      withdraw_no,
      member_no,
      amount,
      bank_name,
      account_number,
      account_holder,
      status,
      created_time
    ) values (
      #{withdrawNo},
      #{memberNo},
      #{amount},
      #{bankName},
      #{accountNumber},
      #{accountHolder},
      'REQUEST',
      systimestamp
    )
  </insert>

  <!-- 단건 조회 -->
  <select id="selectOne" resultType="PointWithdrawDto">
    select
      withdraw_no    as withdrawNo,
      member_no      as memberNo,
      amount         as amount,
      bank_name      as bankName,
      account_number as accountNumber,
      account_holder as accountHolder,
      status         as status,
      created_time   as createdTime,
      processed_time as processedTime,
      processed_by   as processedBy,
      reject_reason  as rejectReason
    from point_withdraw
    where withdraw_no = #{withdrawNo}
  </select>

  <!-- 관리자: 상태별 목록 -->
  <select id="listByStatus" resultType="PointWithdrawDto">
    select
      withdraw_no    as withdrawNo,
      member_no      as memberNo,
      amount         as amount,
      bank_name      as bankName,
      account_number as accountNumber,
      account_holder as accountHolder,
      status         as status,
      created_time   as createdTime,
      processed_time as processedTime,
      processed_by   as processedBy,
      reject_reason  as rejectReason
    from point_withdraw
    where status = #{status}
    order by created_time desc
  </select>

  <!-- 마이페이지: 내 환전 내역 -->
 <select id="listByMember" resultType="PointWithdrawDto">
  select
    withdraw_no    as withdrawNo,
    member_no      as memberNo,
    amount         as amount,
    bank_name      as bankName,
    account_number as accountNumber,
    account_holder as accountHolder,
    status         as status,
    created_time   as createdTime,
    processed_time as processedTime,
    processed_by   as processedBy,
    reject_reason  as rejectReason
  from point_withdraw
  where member_no = #{memberNo}
    and (
      status = 'REQUEST'
      or (
        status in ('DONE','REJECT')
        and processed_time >= add_months(systimestamp, -6)
      )
    )
  order by created_time desc
</select>

<!-- 관리자 승인 -->
<update id="approve" parameterType="PointWithdrawDto">
  update point_withdraw
  set status = 'DONE',
      processed_time = systimestamp,
      processed_by = #{processedBy}
  where withdraw_no = #{withdrawNo}
    and status = 'REQUEST'
</update>

<!-- 관리자 반려 -->
<update id="reject" parameterType="PointWithdrawDto">
  update point_withdraw
  set status = 'REJECT',
      processed_time = systimestamp,
      processed_by = #{processedBy},
      reject_reason = #{rejectReason}
  where withdraw_no = #{withdrawNo}
    and status = 'REQUEST'
</update>
  <!-- 관리자: 상태별 개수 -->
  <select id="countByStatus" resultType="int">
  select count(*)
  from point_withdraw
  where status = #{status}
  <if test="status != null and (status.equals('DONE') or status.equals('REJECT'))">
    and processed_time >= add_months(systimestamp, -6)
  </if>
</select>


  <!-- 관리자: 상태별 페이징 목록 -->
<select id="listByStatusPaging" resultType="PointWithdrawDto">
  select *
  from (
    select
      withdraw_no    as withdrawNo,
      member_no      as memberNo,
      amount         as amount,
      bank_name      as bankName,
      account_number as accountNumber,
      account_holder as accountHolder,
      status         as status,
      created_time   as createdTime,
      processed_time as processedTime,
      processed_by   as processedBy,
      reject_reason  as rejectReason,
      row_number() over (order by created_time desc) rn
    from point_withdraw
    where status = #{status}
    <if test="status != null and (status.equals('DONE') or status.equals('REJECT'))">
      and processed_time >= add_months(systimestamp, -6)
    </if>
  )
  where rn between #{vo.begin} and #{vo.end}
</select>




</mapper>
