<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="product">

	<select id="sequence" resultType="long">
		select product_seq.nextval from dual
	</select>

	<insert id="add">
		insert into product(
			  product_no, seller_no, name, category_code, description
			, start_price, current_price, instant_price, start_time, end_time
		) values (
			  #{productNo}, #{sellerNo}, #{name}, #{categoryCode}, #{description}
			, #{startPrice},  #{currentPrice}, #{instantPrice}, #{startTime}, #{endTime}
		)
	</insert>

	<select id="list" resultType="ProductDto">
		select * from product order by product_no desc
	</select>

	<select id="detail" resultType="ProductDto">
		select * from product where product_no = #{productNo}
	</select>

	<delete id="delete">
		delete from product where product_no = #{productNo}
	</delete>

	<update id="update">
		update product
		set
			  name = #{name}
			, category_code = #{categoryCode}
			, description = #{description}
			, start_price = #{startPrice}
			, final_price = #{finalPrice}
			, instant_price = #{instantPrice}
			, start_time = #{startTime}
			, end_time = #{endTime}
			, status = #{status}
			, buyer_no = #{buyerNo}
		where product_no = #{productNo}
	</update>

	<update id="updateUnit">
		update product
		<set>
			<if test="name != null">name = #{name},</if>
			<if test="categoryCode != null">category_code = #{categoryCode},</if>
			<if test="description != null">description = #{description},</if>
			<if test="startPrice != null">start_price = #{startPrice},</if>
			<if test="finalPrice != null">final_price = #{finalPrice},</if>
			<if test="instantPrice != null">instant_price = #{instantPrice},</if>
			<if test="startTime != null">start_time = #{startTime},</if>
			<if test="endTime != null">end_time = #{endTime},</if>
			<if test="status != null">status = #{status},</if>
			<if test="buyerNo != null">buyer_no = #{buyerNo},</if>
		</set>
		where product_no = #{productNo}
	</update>

	<select id="countByPaging" resultType="int">
		select count(*) from product
	</select>

	<select id="listByPaging" resultType="ProductDto">
		select * from (
			select TMP.*, row_number() over(order by product_no desc) rn
			from product TMP
		)
		where rn between #{begin} and #{end}
	</select>

<select id="selectPurchaseList" parameterType="long" resultType="PurchaseListVO">
    SELECT 
        P.PRODUCT_NO,
        P.NAME AS PRODUCT_NAME,          -- P.PRODUCT_NAME -> P.NAME 수정
        M.NICKNAME AS SELLER_NICKNAME,   -- M.MEMBER_NICKNAME -> M.NICKNAME 수정
        
        -- 대표 이미지 번호 가져오기
        COALESCE(
            (SELECT MIN(ATTACHMENT_NO) 
             FROM ATTACHMENT 
             WHERE PARENT_PK_NO = P.PRODUCT_NO AND CATEGORY = 'PRODUCT'), 0
        ) AS ATTACHMENT_NO,              -- TARGET_NO -> PARENT_PK_NO 수정
        
        -- 내가 이 상품에 입찰한 금액 중 가장 높은 금액
        MAX(B.AMOUNT) AS MY_BID_PRICE,    -- B.BID_PRICE -> B.AMOUNT 수정
        
        -- 상품의 현재 가격 (최고가)
        P.CURRENT_PRICE AS FINAL_PRICE,
        
        P.STATUS AS STATUS,              -- P.PRODUCT_STATUS -> P.STATUS 수정
        P.END_TIME AS END_TIME,          -- P.PRODUCT_CLOSE_DT -> P.END_TIME 수정
        
        -- 주문 테이블에서 결제 상태 확인 (없으면 NULL)
        (SELECT STATUS FROM ORDERS WHERE PRODUCT_NO = P.PRODUCT_NO AND ROWNUM = 1) AS PAYMENT_STATUS
        
    FROM PRODUCT P
    -- 입찰 내역 조인 (내가 입찰한 기록)
    JOIN BID B ON P.PRODUCT_NO = B.PRODUCT_NO
    -- 판매자 정보 조인
    JOIN MEMBER M ON P.SELLER_NO = M.MEMBER_NO
    
    WHERE B.BIDDER_NO = #{memberNo}      -- B.MEMBER_NO -> B.BIDDER_NO 수정
    
    GROUP BY 
        P.PRODUCT_NO, P.NAME, M.NICKNAME, 
        P.CURRENT_PRICE, P.STATUS, P.END_TIME
        
    ORDER BY P.END_TIME DESC
</select>

	<update id="updateOnBid">
		update product
		set final_price = #{bidAmount}, buyer_no = #{bidMemberNo}, status = 'BIDDING'
		where product_no = #{productNo}
	</update>

	<update id="closeAuction">
		update product
		set status = 'CLOSED', ended_time = systimestamp
		where product_no = #{productNo}
	</update>

	<update id="updateStatus">
		update product set status = #{changeStatus} where product_no = #{productNo}
	</update>
	
	<update id ="updateCurrentPrice">
		update product 
		set
			current_price = #{currentPrice}
		where product_no = #{productNo}
	</update>

	<update id="updateProductOnAuctionEnd">
		update product
		set status = 'ENDED', final_price = #{finalPrice}, buyer_no = #{buyerNo}, ended_time = systimestamp
		where product_no = #{productNo}
	</update>

	<select id="selectOneForUpdate" resultType="ProductDto">
		select * from product where product_no = #{productNo} for update nowait
	</select>
	
	<select id="findExpiredProductNos" resultType="Long">
   		select product_no from product
    	where <![CDATA[ end_time <= systimestamp ]]> and status = 'BIDDING'
	</select>
	
	<select id="findStartableProductNos" resultType="Long">
	    select product_no from product
	    where <![CDATA[ start_time <= systimestamp ]]> and status = 'REGISTRATION'
    </select>
	
	<select id="findSellerByRegProductNo" resultType="long">
		select seller_no 
		from product 
		where 
			product_no = #{productNo} and
	        <![CDATA[
	            start_time <= systimestamp
	        ]]>
	        and status = 'REGISTRATION'
	</select>
	
	<select id="findSellerNoByProductNo" resultType="Long">
		select seller_no
		from product
		where product_no = #{productNo}
	</select>
	
	<select id="countBySeller" resultType="int">
		select count(*)
		from product
		where seller_no = #{sellerNo}
	</select>

	<select id="listBySellerPaging" resultType="ProductDto">
		select *
		from (
			select TMP.*, row_number() over(order by product_no desc) rn
			from product TMP
			where seller_no = #{sellerNo}
		)
		where rn between #{begin} and #{end}
	</select>

	<select id="countByBidding" resultType="int">
		select count(*) from product where status = 'BIDDING'
	</select>

	<select id="listByBiddingPaging" resultType="ProductDto">
		select *
		from (
			select TMP.*, row_number() over(order by product_no desc) rn
			from product TMP
			where status = 'BIDDING'
		)
		where rn between #{begin} and #{end}
	</select>
	
    <sql id="auctionSearch">
        WHERE status = 'BIDDING' AND end_time > systimestamp
        
        <if test="q != null and q != ''">
            AND name LIKE '%' || #{q} || '%'
        </if>
        
        <if test="category != null">
            AND (
                category_code = #{category} 
                OR 
                category_code IN (SELECT category_code FROM category WHERE parent_code = #{category})
            )
        </if>
        
        <if test="minPrice != null">
            AND (final_price &gt;= #{minPrice} OR start_price &gt;= #{minPrice})
        </if>
        <if test="maxPrice != null">
            AND (final_price &lt;= #{maxPrice} OR start_price &lt;= #{maxPrice})
        </if>
    </sql>

    <select id="countAuction" resultType="int">
      select count(*)
      from product
      <include refid="auctionSearch"/>
    </select>
    
    <select id="listAuctionByPaging" resultType="ProductDto">
      select *
      from (
        select TMP.*, row_number() over(
            ORDER BY 
            <choose>
                <when test="sort == 'PRICE_DESC'"> 
                    COALESCE(final_price, start_price) DESC 
                </when>
                <when test="sort == 'PRICE_ASC'"> 
                    COALESCE(final_price, start_price) ASC 
                </when>
                <when test="sort == 'NEW'"> 
                    start_time DESC 
                </when>
                <otherwise> 
                    end_time ASC 
                </otherwise>
            </choose>
        ) rn
        from product TMP
        <include refid="auctionSearch"/>
      )
      where rn between #{begin} and #{end}
    </select>
    
 
    <select id="selectClosingSoon" resultType="ProductDto">
        SELECT * FROM (
            SELECT 
                P.*, 
                (SELECT MIN(ATTACHMENT_NO) 
                 FROM ATTACHMENT 
                 WHERE PARENT_PK_NO = P.PRODUCT_NO AND CATEGORY = 'PRODUCT') AS ATTACHMENT_NO
            FROM PRODUCT P
            WHERE P.STATUS = 'BIDDING' 
              AND P.END_TIME > SYSTIMESTAMP
            ORDER BY P.END_TIME ASC
        ) WHERE ROWNUM &lt;= 4
    </select>

    
    

    <delete id="deleteEscrow"> delete from escrow_ledger where product_no = #{productNo} </delete>
    <delete id="deleteBid"> delete from bid where product_no = #{productNo} </delete>
    <delete id="deletePointHistory"> delete from point_history where product_no = #{productNo} </delete>
    <delete id="deleteReview"> delete from review where product_no = #{productNo} </delete>
    <delete id="deleteMessage"> delete from message where product_no = #{productNo} </delete>
    <delete id="deleteOrders"> delete from orders where product_no = #{productNo} </delete>

</mapper>