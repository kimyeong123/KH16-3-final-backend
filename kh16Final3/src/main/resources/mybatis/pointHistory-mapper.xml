<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="pointHistory">

    <select id="sequence" resultType="long">
        select point_history_seq.nextval
        from dual
    </select>

    <insert id="insert">
        insert into 
        	point_history(
            	point_history_no, member_no, type, 
              	amount, reason, product_no
        ) values(
              #{pointHistoryNo}, #{memberNo}, #{type}, 
              #{amount}, #{reason}, #{productNo}
        )
    </insert>
    <!-- 포인트 충전용 -->
    <insert id="insertCharge">
    insert into point_history(
    point_history_no, member_no, amount,
    type, reason, fee_amount
  ) values (
    point_history_seq.nextval, #{memberNo}, #{amount},
     #{type}, #{reason}, #{feeAmount}
  )
    </insert>

    
    <insert id="insertSettlementHistory">
        insert into 
        	point_history(
            	point_history_no, member_no, type, 
              	amount, fee_amount, reason, product_no
        ) values(
              #{pointHistoryNo}, #{memberNo}, #{type}, 
              #{amount}, #{feeAmount}, #{reason}, #{productNo}
        )
    </insert>

    <select id="detail" resultType="PointHistoryDto">
        select *
        from point_history
        where 
        	point_history_no = #{pointHistoryNo}
        order by point_history_no desc
    </select>

    <select id="listByMember" resultType="PointHistoryDto">
        select *
        from point_history
        where member_no = #{memberNo}
        order by created_time desc
    </select>
    
	<select id="calculateMemberBalance" resultType="long">
	 	select nvl(
	    	sum(case
	      		when type = 'ADD' then amount
	      		when type = 'DEDUCT' then -amount
	      		else 0
	    		end), 0
	  			) as current_point_balance
	  		from point_history
	  	where member_no = #{memberNo}
	</select>
	<!--마이페이지에서 충전내역-->
	<select id="listChargeHistoryByMember"
        resultType="PointChargeHistoryVO">
		select
		point_history_no AS pointHistoryNo, type, amount, reason, created_time
		AS createdTime
		from point_charge_history
		where member_no = #{memberNo}
		order by created_time desc
     </select>
     <!--마이페이지에서 입찰내역-->
     <select id="listMemberBidHistory"
        resultType="MemberBidHistoryVO">
  select
    x.product_no    as productNo,
    p.name          as productName,
    p.status         as status,
    x.amount        as lastBidAmount,
    x.created_time  as lastBidTime
  from (
    select
      ph.product_no,
      ph.amount,
      ph.created_time,
      ph.point_history_no,
      row_number() over (
        partition by ph.product_no
        order by ph.created_time desc, ph.point_history_no desc
      ) rn
    from point_history ph
    where ph.member_no = #{memberNo}
      and upper(ph.reason) = 'BID_LOCKED'
      and ph.product_no is not null
  ) x
  join product p
    on p.product_no = x.product_no
  where x.rn = 1
  order by x.created_time desc
</select>

<!-- 환전 요청 시 차감 -->
<insert id="insertWithdrawDeduct" parameterType="PointWithdrawDto">
  insert into point_history(
    point_history_no, member_no, type, amount, reason, related_no
  ) values (
    point_history_seq.nextval,
    #{memberNo},
    'DEDUCT',
    #{amount},
    'WITHDRAWN',
    #{withdrawNo}
  )
</insert>

<!-- 환전 반려 시 복구 -->
<insert id="insertWithdrawRefund" parameterType="PointWithdrawDto">
  insert into point_history(
    point_history_no, member_no, type, amount, reason, related_no
  ) values (
    point_history_seq.nextval,
    #{memberNo},
    'ADD',
    #{amount},
    'WITHDRAWN',
    #{withdrawNo}
  )
</insert>


	
	<delete id="deleteByProductNo">
    DELETE FROM point_history WHERE product_no = #{productNo}
</delete>
</mapper>
