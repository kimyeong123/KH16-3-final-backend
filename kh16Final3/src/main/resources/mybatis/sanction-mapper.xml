<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="sanction">
    
    <select id="sequence" resultType="long">
        SELECT sanction_seq.NEXTVAL FROM DUAL
    </select>
    
    <insert id="insert" parameterType="SanctionDto">
        INSERT INTO sanction (
            sanction_no, member_no, type, duration_day,
            start_time, end_time, reason, status
        )
        VALUES (
            #{sanctionNo}, #{memberNo}, #{type}, #{durationDay}, 
            #{startTime}, #{endTime}, #{reason}, #{status}
        )
    </insert>
    
    <select id="selectOne" parameterType="long" resultType="SanctionDto">
        SELECT 
            sanction_no AS sanctionNo,
            member_no AS memberNo,
            type,
            duration_day AS durationDay,
            start_time AS startTime,
            end_time AS endTime,
            reason,
            status
        FROM sanction
        WHERE sanction_no = #{sanctionNo}
    </select>
    
    <select id="selectValidSanctionsByMember" parameterType="long" resultType="SanctionDto">
        SELECT 
            sanction_no AS sanctionNo,
            member_no AS memberNo,
            type,
            duration_day AS durationDay,
            start_time AS startTime,
            end_time AS endTime,
            reason,
            status
        FROM sanction
        WHERE member_no = #{memberNo}
        AND status = 'Y'
        AND end_time > SYSTIMESTAMP  
        ORDER BY start_time DESC
    </select>
    
    <update id="updateStatus" parameterType="SanctionDto">
        UPDATE sanction
        SET status = #{status}
        WHERE sanction_no = #{sanctionNo}
    </update>
    
    <delete id="delete" parameterType="long">
        DELETE FROM sanction
        WHERE sanction_no = #{sanctionNo}
    </delete>
    
    <select id="count" resultType="int">
        SELECT COUNT(*) FROM sanction
    </select>
    
    <select id="selectHistoryWithPaging" parameterType="map" resultType="SanctionDto">
        SELECT *
        FROM (
            SELECT rownum rn, tmp.*
            FROM (
                SELECT 
                    s.sanction_no AS sanctionNo,
                    s.member_no AS memberNo,
                    s.type,
                    s.duration_day AS durationDay,
                    s.start_time AS startTime,
                    s.end_time AS endTime,
                    s.reason,
                    s.status,
                    m.member_nickname AS memberNickname
                FROM sanction s
                LEFT OUTER JOIN member m ON s.member_no = m.member_no
                ORDER BY s.sanction_no DESC
            ) tmp
        )
        WHERE rn BETWEEN #{begin} AND #{end}
    </select>

</mapper>