<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="message"> 

	<select id="sequence" resultType="int">
		select messages_seq.nextval from dual
	</select>

	<insert id="insert" parameterType="MessageDto">
		insert into messages (
			message_no, sender_no, receiver_no, content, type
		)
		values (
			#{messageNo}, #{senderNo}, #{receiverNo}, #{content}, #{type}
		)
	</insert>
	
    <select id="selectSentList" parameterType="long" resultType="MessageDto">
		select 
			message_no, 
			sender_no, 
			receiver_no, 
			content,
			type,
			sent_time as sentTime,           
			read_time as readTime,           
			is_read as isRead,               
			sender_deleted as senderDeleted, 
			receiver_deleted as receiverDeleted
		from messages 
		where sender_no = #{memberNo} 
		and sender_deleted = 'N'
		order by message_no desc
	</select>
	
	<select id="selectReceivedList" parameterType="long" resultType="MessageDto">
		select 
			message_no, 
			sender_no, 
			receiver_no, 
			content,
			type,
			sent_time as sentTime, 
			read_time as readTime, 
			is_read as isRead,
			sender_deleted as senderDeleted, 
			receiver_deleted as receiverDeleted
		from messages
		where receiver_no = #{memberNo} 
		and receiver_deleted = 'N'
		order by message_no desc
	</select>
	
	<select id="selectOne" parameterType="int" resultType="MessageDto">
		select 
			message_no, 
			sender_no, 
			receiver_no, 
			content,
			type,
			sent_time as sentTime, 
			read_time as readTime, 
			is_read as isRead,
			sender_deleted as senderDeleted, 
			receiver_deleted as receiverDeleted
		from messages
		where message_no = #{messageNo}
	</select>
	
	<update id="updateReadTime" parameterType="int">
		update messages set
			is_read = 'Y',
			read_time = systimestamp
		where message_no = #{messageNo}
	</update>
	
	<update id="updateSenderDelete" parameterType="int">
		update messages set
			sender_deleted = 'Y'
		where message_no = #{messageNo}
	</update>
	
	<update id="updateReceiverDelete" parameterType="int">
		update messages set
			receiver_deleted = 'Y'
		where message_no = #{messageNo}
	</update>
	
	<select id="countUnreadAlerts" parameterType="long" resultType="int">
		select count(*) 
		from messages
		where receiver_no = #{memberNo}
		and is_read = 'N'
		and type = 'SYSTEM_ALERT'
		and receiver_deleted = 'N'
	</select>
	
	<select id="selectReceivedListByTypes" parameterType="map" resultType="MessageDto">
		select 
			message_no, 
			sender_no, 
			receiver_no, 
			content,
			type,
			sent_time as sentTime, 
			read_time as readTime, 
			is_read as isRead,
			sender_deleted as senderDeleted, 
			receiver_deleted as receiverDeleted
		from messages
		where receiver_no = #{memberNo}
		and receiver_deleted = 'N'
		and type in 
		<foreach collection="typeList" item="type" open="(" close=")" separator=",">
			#{type}
		</foreach>
		order by message_no desc
	</select>

</mapper>