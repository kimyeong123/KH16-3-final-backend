<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="product">

	<select id="sequence" resultType="long">
		select product_seq.nextval from dual
	</select>

	<insert id="add">
		insert into product(
			  product_no, seller_no, name, category_code, description
			, start_price, current_price, instant_price, start_time, end_time
		) values (
			  #{productNo}, #{sellerNo}, #{name}, #{categoryCode}, #{description}
			, #{startPrice},  #{currentPrice}, #{instantPrice}, #{startTime}, #{endTime}
		)
	</insert>

	<select id="list" resultType="ProductDto">
		select * from product order by product_no desc
	</select>

	<select id="detail" resultType="ProductDto">
		select * from product where product_no = #{productNo}
	</select>

	<delete id="delete">
		delete from product where product_no = #{productNo}
	</delete>

	<update id="update">
		update product
		set
			  name = #{name}
			, category_code = #{categoryCode}
			, description = #{description}
			, start_price = #{startPrice}
			, final_price = #{finalPrice}
			, instant_price = #{instantPrice}
			, start_time = #{startTime}
			, end_time = #{endTime}
			, status = #{status}
			, buyer_no = #{buyerNo}
		where product_no = #{productNo}
	</update>

	<update id="updateUnit">
		update product
		<set>
			<if test="name != null">name = #{name},</if>
			<if test="categoryCode != null">category_code = #{categoryCode},</if>
			<if test="description != null">description = #{description},</if>
			<if test="startPrice != null">start_price = #{startPrice},</if>
			<if test="finalPrice != null">final_price = #{finalPrice},</if>
			<if test="instantPrice != null">instant_price = #{instantPrice},</if>
			<if test="startTime != null">start_time = #{startTime},</if>
			<if test="endTime != null">end_time = #{endTime},</if>
			<if test="status != null">status = #{status},</if>
			<if test="buyerNo != null">buyer_no = #{buyerNo},</if>
		</set>
		where product_no = #{productNo}
	</update>

	<select id="countByPaging" resultType="int">
		select count(*) from product
	</select>

	<select id="listByPaging" resultType="ProductDto">
		select * from (
			select TMP.*, row_number() over(order by product_no desc) rn
			from product TMP
		)
		where rn between #{begin} and #{end}
	</select>

	<update id="updateOnBid">
		update product
		set final_price = #{bidAmount}, buyer_no = #{bidMemberNo}, status = 'BIDDING'
		where product_no = #{productNo}
	</update>

	<update id="closeAuction">
		update product
		set status = 'CLOSED', ended_time = systimestamp
		where product_no = #{productNo}
	</update>

	<update id="updateStatus">
		update product set status = #{changeStatus} where product_no = #{productNo}
	</update>
	
	<update id ="updateCurrentPrice">
		update product 
		set
			current_price = #{currentPrice}
		where product_no = #{productNo}
	</update>

	<update id="updateProductOnAuctionEnd">
		update product
		set status = 'ENDED', final_price = #{finalPrice}, buyer_no = #{buyerNo}, ended_time = systimestamp
		where product_no = #{productNo}
	</update>

	<select id="selectOneForUpdate" resultType="ProductDto">
		select * from product where product_no = #{productNo} for update nowait
	</select>
	
	<select id="findExpiredProductNos" resultType="Long">
   		select product_no from product
    	where <![CDATA[ end_time <= systimestamp ]]> and status = 'BIDDING'
	</select>
	
	<select id="findStartableProductNos" resultType="Long">
	    select product_no from product
	    where <![CDATA[ start_time <= systimestamp ]]> and status = 'REGISTRATION'
    </select>
	
	<select id="findSellerByRegProductNo" resultType="long">
		select seller_no 
		from product 
		where 
			product_no = #{productNo} and
	        <![CDATA[
	            start_time <= systimestamp
	        ]]>
	        and status = 'REGISTRATION'
	</select>
	
	<select id="findSellerNoByProductNo" resultType="Long">
		select seller_no
		from product
		where product_no = #{productNo}
	</select>
	
	<select id="countBySeller" resultType="int">
		select count(*)
		from product
		where seller_no = #{sellerNo}
	</select>

	<select id="listBySellerPaging" resultType="ProductDto">
		select *
		from (
			select TMP.*, row_number() over(order by product_no desc) rn
			from product TMP
			where seller_no = #{sellerNo}
		)
		where rn between #{begin} and #{end}
	</select>

	<select id="countByBidding" resultType="int">
		select count(*) from product where status = 'BIDDING'
	</select>

	<select id="listByBiddingPaging" resultType="ProductDto">
		select *
		from (
			select TMP.*, row_number() over(order by product_no desc) rn
			from product TMP
			where status = 'BIDDING'
		)
		where rn between #{begin} and #{end}
	</select>
	
    <sql id="auctionSearch">
        WHERE status = 'BIDDING' AND end_time > systimestamp
        
        <if test="q != null and q != ''">
            AND name LIKE '%' || #{q} || '%'
        </if>
        
        <if test="category != null">
            AND (
                category_code = #{category} 
                OR 
                category_code IN (SELECT category_code FROM category WHERE parent_code = #{category})
            )
        </if>
        
        <if test="minPrice != null">
            AND (final_price &gt;= #{minPrice} OR start_price &gt;= #{minPrice})
        </if>
        <if test="maxPrice != null">
            AND (final_price &lt;= #{maxPrice} OR start_price &lt;= #{maxPrice})
        </if>
    </sql>

    <select id="countAuction" resultType="int">
      select count(*)
      from product
      <include refid="auctionSearch"/>
    </select>
    
    <select id="listAuctionByPaging" resultType="ProductDto">
      select *
      from (
        select TMP.*, row_number() over(
            ORDER BY 
            <choose>
                <when test="sort == 'PRICE_DESC'"> 
                    COALESCE(final_price, start_price) DESC 
                </when>
                <when test="sort == 'PRICE_ASC'"> 
                    COALESCE(final_price, start_price) ASC 
                </when>
                <when test="sort == 'NEW'"> 
                    start_time DESC 
                </when>
                <otherwise> 
                    end_time ASC 
                </otherwise>
            </choose>
        ) rn
        from product TMP
        <include refid="auctionSearch"/>
      )
      where rn between #{begin} and #{end}
    </select>
    
 
    <select id="selectClosingSoon" resultType="ProductDto">
        SELECT * FROM (
            SELECT 
                P.*, 
                (SELECT MIN(ATTACHMENT_NO) 
                 FROM ATTACHMENT 
                 WHERE PARENT_PK_NO = P.PRODUCT_NO AND CATEGORY = 'PRODUCT') AS ATTACHMENT_NO
            FROM PRODUCT P
            WHERE P.STATUS = 'BIDDING' 
              AND P.END_TIME > SYSTIMESTAMP
            ORDER BY P.END_TIME ASC
        ) WHERE ROWNUM &lt;= 4
    </select>

    
    

    <delete id="deleteEscrow"> delete from escrow_ledger where product_no = #{productNo} </delete>
    <delete id="deleteBid"> delete from bid where product_no = #{productNo} </delete>
    <delete id="deletePointHistory"> delete from point_history where product_no = #{productNo} </delete>
    <delete id="deleteReview"> delete from review where product_no = #{productNo} </delete>
    <delete id="deleteMessage"> delete from message where product_no = #{productNo} </delete>
    <delete id="deleteOrders"> delete from orders where product_no = #{productNo} </delete>

	<select id="selectPurchaseList"
        resultType="PurchaseListVO">
		    SELECT *
	FROM (
	    SELECT
	        t.*,
	        ROWNUM rn
	    FROM (
	        SELECT
	            p.product_no    AS productNo,
	            p.name          AS productName,
	            p.status        AS status,
	            p.end_time      AS endTime,
	            p.final_price   AS finalPrice,
	
	            m.nickname      AS sellerNickname,
	            a.attachment_no AS attachmentNo,
	            o.order_no      AS orderNo,
	
	            (
	                SELECT MAX(b2.amount)
	                FROM bid b2
	                WHERE b2.product_no = p.product_no
	                  AND b2.bidder_no = #{loginNo}
	            ) AS myBidPrice,
	
	            -- 배송지 입력 완료 여부
	            CASE
	                WHEN o.receiver_name IS NOT NULL THEN 1
	                ELSE 0
	            END AS shippingCompleted
	
	        FROM product p
	        JOIN member m ON p.seller_no = m.member_no
	        LEFT JOIN orders o
	               ON o.product_no = p.product_no
	              AND o.buyer_no = #{loginNo}
	        LEFT JOIN attachment a
	               ON a.parent_pk_no = p.product_no
	              AND a.category = 'PRODUCT'
	
	        WHERE EXISTS (
	            SELECT 1
	            FROM bid b
	            WHERE b.product_no = p.product_no
	              AND b.bidder_no = #{loginNo}
	        )
	
	        ORDER BY p.end_time DESC
	    ) t
	    WHERE <![CDATA[
    		ROWNUM <= #{end}
		]]>
	)
	WHERE <![CDATA[
    	rn >= #{begin}
		]]>
	</select>

	<select id="countPurchase"
	        resultType="int">
	    SELECT COUNT(*)
	    FROM product p
	    WHERE EXISTS (
	        SELECT 1
	        FROM bid b
	        WHERE b.product_no = p.product_no
	          AND b.bidder_no = #{memberNo}
	    )
	</select>
	
	<select id="selectSalesList"
        resultType="SalesListVO">
	SELECT *
	FROM (
	    SELECT
	        t.*,
	        ROWNUM rn
	    FROM (
	        SELECT
	            /* ===== 식별 ===== */
	            p.product_no        AS productNo,
	            o.order_no          AS orderNo,
	
	            /* ===== 상품 ===== */
	            p.name              AS productName,
	            a.attachment_no     AS attachmentNo,
	
	            /* ===== 구매자 ===== */
	            bm.nickname         AS buyerNickname,
	
	            /* ===== 가격 ===== */
	            o.final_price       AS finalPrice,
	
	            /* ===== 상태 ===== */
	            p.status            AS productStatus,
	            o.status            AS orderStatus,
	
	            p.end_time          AS endTime,
	
	            /* ===== 송장 입력 여부 ===== */
	            CASE
	                WHEN o.courier IS NOT NULL
	                 AND o.tracking_number IS NOT NULL
	                THEN 1
	                ELSE 0
	            END AS invoiceRegistered
	
	        FROM product p
	
	        /* 주문 (낙찰 후에만 존재) */
	        LEFT JOIN orders o
	               ON o.product_no = p.product_no
	              AND o.seller_no = #{loginNo}
	
	        /* 구매자 */
	        LEFT JOIN member bm
	               ON o.buyer_no = bm.member_no
	
	        /* 썸네일 (1개만) */
	        LEFT JOIN attachment a
	               ON a.parent_pk_no = p.product_no
	              AND a.category = 'PRODUCT'
	
	        /* 판매자 기준 */
	        WHERE p.seller_no = #{loginNo}
	
	        ORDER BY p.end_time DESC
	    ) t
	    WHERE <![CDATA[
    		ROWNUM <= #{end}
		]]>
	)
	WHERE <![CDATA[
    		rn >= #{begin}
		]]>
	</select>

	<select id="countSales"
        resultType="int">
		SELECT COUNT(*)
		FROM product p
		WHERE p.seller_no = #{loginNo}
	</select>

</mapper>
